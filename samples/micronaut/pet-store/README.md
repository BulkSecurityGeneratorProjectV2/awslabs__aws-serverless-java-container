# Micronaut Native Pet store example  

The [Micronaut framework](https://micronaut.io/) is compatible with Spring's annotations and makes it easy to use [GraalVM](https://www.graalvm.org/) to build application images into native binaries. Further, Micronaut includes builtin support for AWS Lambda.

This demo application shows how to use Micronaut to compile our standard pet store example, using Spring annotations, into a native binary with GraalVM and execute it in AWS Lambda. To run this demo, you will need to have [Gradle](https://gradle.org/) installed as well as [Docker](https://www.docker.com/) to run the GraalVM build.

With all the pre-requisites installed including:

* JDK 8 or above
* Gradle 5.6.x
 
You should be able to build a native image of the application by running the following command from the repository's root.

```bash
$ gradle buildNativeLambda -Pmicronaut.runtime=lambda
```
This will build the GraalVM native image inside a docker container and generate the `function.zip` in `build/libs/` ready for the deployment.

To run the lambda locally, you can utilize the SAM cli by running `./sam-local.sh`. This should start up the listeners in the `PetsController`, and you can test locally with your preferred http client.

For example, to test the GET /pets endpoint via curl:
```bash
curl localhost:3000/pets
```

You should see JSON output of pets.

To deploy the application to AWS Lambda you can use the pre-configured `sam-native.yaml` file included in the repo. Using the AWS or SAM CLI, run the following commands:

```bash
$ aws cloudformation package --template-file sam-native.yaml \
                             --output-template-file packaged-sam.yaml \
                             --s3-bucket <YOUR_S3_BUCKET>
Uploading to d3e2617f3c8c2e8ca78e35a0dc856884  18553505 / 18553505.0  (100.00%)
Successfully packaged artifacts and wrote output template to file packaged-sam.yaml.
Execute the following command to deploy the packaged template
aws cloudformation deploy --template-file /workspace/graal-spring-demo/packaged-sam.yaml --stack-name <YOUR STACK NAME>


$ aws cloudformation deploy --template-file ./packaged-sam.yaml --stack-name MicronautGraalVmDemo --capabilities CAPABILITY_IAM

Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - MicronautGraalVmDemo
```

You can use the AWS CLI to get the API endpoint generated by the deployment process:

```bash
aws cloudformation describe-stacks --stack-name MicronautGraalVmDemo --query Stacks[0].Outputs[0].OutputValue
"https://xxxxxxxxxx.execute-api.xx-xxxx-1.amazonaws.com/Prod/pets"
```

Make a test request to the API endpoint using curl or your preferred http client. 

For example, to check the GET /pets endpoint via curl:
```bash
curl https://xxxxxxxxxx.execute-api.xx-xxxx-1.amazonaws.com/Prod/pets
```
